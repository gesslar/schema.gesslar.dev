{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://schema.gesslar.dev/muddler/v1/muddler-unified.json",
  "title": "Muddler Unified Schema",
  "description": "Unified schema containing all muddler JSON schemas with anchors for per-file use.",
  "$defs": {
    "common": {
      "$defs": {
        "yesNo": {
          "description": "Mudlet stores many booleans as the strings \"yes\"/\"no\"; muddler also accepts real booleans and coerces them.",
          "anyOf": [
            {
              "type": "string",
              "enum": [
                "yes",
                "no"
              ]
            },
            {
              "type": "boolean"
            }
          ],
          "default": "yes"
        },
        "luaScript": {
          "type": "string",
          "description": "Lua code. Leave empty to let muddler pull the matching .lua file from src/<type>/... during build.",
          "default": ""
        },
        "hexColor": {
          "type": "string",
          "pattern": "^#([A-Fa-f0-9]{6})$",
          "description": "RGB hex color in #rrggbb form."
        },
        "durationString": {
          "type": "string",
          "pattern": "^\\d{2}:\\d{2}:\\d{2}\\.\\d{3}$",
          "description": "Timer duration string (hh:mm:ss.mmm)."
        },
        "fileRef": {
          "type": "string",
          "description": "Relative path used internally by muddler; usually set automatically."
        }
      }
    },
    "script": {
      "type": "object",
      "required": [
        "name"
      ],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Display name of the script."
        },
        "isActive": {
          "$ref": "#/$defs/common/$defs/yesNo"
        },
        "isFolder": {
          "$ref": "#/$defs/common/$defs/yesNo"
        },
        "script": {
          "$ref": "#/$defs/common/$defs/luaScript"
        },
        "eventHandlerList": {
          "type": "array",
          "description": "List of Mudlet events this script handles (e.g. sysInstall).",
          "items": {
            "type": "string"
          }
        },
        "children": {
          "type": "array",
          "description": "Nested scripts when used as a folder (isFolder=yes).",
          "items": {
            "$ref": "#/$defs/script"
          }
        }
      }
    },
    "alias": {
      "type": "object",
      "required": [
        "name"
      ],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Display name of the alias."
        },
        "isActive": {
          "$ref": "#/$defs/common/$defs/yesNo"
        },
        "isFolder": {
          "$ref": "#/$defs/common/$defs/yesNo"
        },
        "command": {
          "type": "string",
          "description": "Command text (optional convenience alongside regex/script)."
        },
        "regex": {
          "type": "string",
          "description": "Regex or exact match for the alias."
        },
        "script": {
          "$ref": "#/$defs/common/$defs/luaScript"
        },
        "children": {
          "type": "array",
          "description": "Nested aliases when used as a folder (isFolder=yes).",
          "items": {
            "$ref": "#/$defs/alias"
          }
        }
      }
    },
    "triggerPattern": {
      "type": "object",
      "required": [
        "pattern"
      ],
      "additionalProperties": false,
      "properties": {
        "pattern": {
          "type": "string",
          "description": "Pattern text. For color triggers, use \"fg,bg\" (e.g. \"2,0\"). Prompt triggers may be empty."
        },
        "type": {
          "type": "string",
          "description": "Pattern type.",
          "enum": [
            "substring",
            "regex",
            "startOfLine",
            "exactMatch",
            "lua",
            "spacer",
            "color",
            "colour",
            "prompt"
          ],
          "default": "substring"
        }
      }
    },
    "trigger": {
      "type": "object",
      "required": [
        "name"
      ],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Display name of the trigger."
        },
        "isActive": {
          "$ref": "#/$defs/common/$defs/yesNo"
        },
        "isFolder": {
          "$ref": "#/$defs/common/$defs/yesNo"
        },
        "script": {
          "$ref": "#/$defs/common/$defs/luaScript"
        },
        "patterns": {
          "type": "array",
          "minItems": 1,
          "description": "List of trigger patterns.",
          "items": {
            "$ref": "#/$defs/triggerPattern"
          }
        },
        "multiline": {
          "$ref": "#/$defs/common/$defs/yesNo",
          "description": "Treat as multiline trigger."
        },
        "multilineDelta": {
          "description": "Number of lines after the first match to keep open when multiline=yes.",
          "anyOf": [
            {
              "type": "integer",
              "minimum": 0
            },
            {
              "type": "string",
              "pattern": "^\\d+$"
            }
          ]
        },
        "matchall": {
          "$ref": "#/$defs/common/$defs/yesNo",
          "description": "Perl /g style matching."
        },
        "filter": {
          "$ref": "#/$defs/common/$defs/yesNo",
          "description": "Mark as filter trigger."
        },
        "fireLength": {
          "description": "Stay-open duration in milliseconds.",
          "anyOf": [
            {
              "type": "integer",
              "minimum": 0
            },
            {
              "type": "string",
              "pattern": "^\\d+$"
            }
          ],
          "default": "0"
        },
        "soundFile": {
          "type": "string",
          "description": "Sound file to play on fire (enables sound trigger)."
        },
        "highlight": {
          "$ref": "#/$defs/common/$defs/yesNo",
          "description": "Enable colorizer trigger."
        },
        "highlightFG": {
          "$ref": "#/$defs/common/$defs/hexColor"
        },
        "highlightBG": {
          "$ref": "#/$defs/common/$defs/hexColor"
        },
        "command": {
          "type": "string",
          "description": "Command to execute when trigger fires (mCommand)."
        },
        "children": {
          "type": "array",
          "description": "Nested triggers when used as a folder (isFolder=yes).",
          "items": {
            "$ref": "#/$defs/trigger"
          }
        }
      }
    },
    "timer": {
      "type": "object",
      "required": [
        "name"
      ],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Display name of the timer."
        },
        "isActive": {
          "$ref": "#/$defs/common/$defs/yesNo"
        },
        "isFolder": {
          "$ref": "#/$defs/common/$defs/yesNo"
        },
        "script": {
          "$ref": "#/$defs/common/$defs/luaScript"
        },
        "command": {
          "type": "string",
          "description": "Command text (optional convenience alongside script)."
        },
        "time": {
          "$ref": "#/$defs/common/$defs/durationString",
          "description": "Timer duration. If omitted, constructed from hours/minutes/seconds/milliseconds."
        },
        "hours": {
          "type": [
            "integer",
            "string"
          ],
          "description": "Hours component (0-23)."
        },
        "minutes": {
          "type": [
            "integer",
            "string"
          ],
          "description": "Minutes component (0-59)."
        },
        "seconds": {
          "type": [
            "integer",
            "string"
          ],
          "description": "Seconds component (0-59)."
        },
        "milliseconds": {
          "type": [
            "integer",
            "string"
          ],
          "description": "Milliseconds component (0-999)."
        },
        "children": {
          "type": "array",
          "description": "Nested timers when used as a folder (isFolder=yes).",
          "items": {
            "$ref": "#/$defs/timer"
          }
        }
      }
    },
    "key": {
      "type": "object",
      "required": [
        "name"
      ],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Display name of the keybinding."
        },
        "isActive": {
          "$ref": "#/$defs/common/$defs/yesNo"
        },
        "isFolder": {
          "$ref": "#/$defs/common/$defs/yesNo"
        },
        "script": {
          "$ref": "#/$defs/common/$defs/luaScript"
        },
        "command": {
          "type": "string",
          "description": "Command text (optional convenience alongside script)."
        },
        "keys": {
          "type": "string",
          "description": "Human-readable combo, e.g. \"ctrl+shift+alt+c\" or \"f1\". Parsed into keyCode/keyModifier during build."
        },
        "keyCode": {
          "type": "string",
          "description": "Optional explicit key code override."
        },
        "keyModifier": {
          "type": "string",
          "description": "Optional explicit modifier code override."
        },
        "children": {
          "type": "array",
          "description": "Nested keybindings when used as a folder (isFolder=yes).",
          "items": {
            "$ref": "#/$defs/key"
          }
        }
      }
    },
    "mfile": {
      "$anchor": "mfile",
      "type": "object",
      "additionalProperties": false,
      "required": [
        "package"
      ],
      "properties": {
        "package": {
          "type": "string",
          "description": "Mudlet package name."
        },
        "version": {
          "type": "string",
          "description": "Package version (e.g. 1.0.0)."
        },
        "author": {
          "type": "string",
          "description": "Author name displayed in Mudlet."
        },
        "title": {
          "type": "string",
          "description": "One-line package title/description."
        },
        "description": {
          "type": "string",
          "description": "Longer description (fallbacks to README.md if absent)."
        },
        "icon": {
          "type": "string",
          "description": "Filename under src/resources used as package icon."
        },
        "dependencies": {
          "type": "string",
          "description": "Comma-separated Mudlet package dependencies."
        },
        "outputFile": {
          "type": "boolean",
          "description": "Whether to emit .output with package path after build.",
          "default": false
        }
      }
    },
    "scripts": {
      "$anchor": "scripts",
      "type": "array",
      "items": {
        "$ref": "#/$defs/script"
      }
    },
    "aliases": {
      "$anchor": "aliases",
      "type": "array",
      "items": {
        "$ref": "#/$defs/alias"
      }
    },
    "triggers": {
      "$anchor": "triggers",
      "type": "array",
      "items": {
        "$ref": "#/$defs/trigger"
      }
    },
    "timers": {
      "$anchor": "timers",
      "type": "array",
      "items": {
        "$ref": "#/$defs/timer"
      }
    },
    "keys": {
      "$anchor": "keys",
      "type": "array",
      "items": {
        "$ref": "#/$defs/key"
      }
    }
  }
}
